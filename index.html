<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>반려동물 병원 이용 설문조사</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Tailwind default) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        /* 커스텀 스타일 */
        .record {
            background-color: #ffffff;
            border-left: 4px solid #3b82f6; /* Blue border */
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.5s ease forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .record.fade-in {
            animation-delay: var(--delay);
        }
        .text-accent { color: #10b981; /* Emerald */ }
        .text-muted { color: #9ca3af; /* Gray */ }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', // Blue-500
                        'secondary': '#10b981', // Emerald-500
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8 min-h-screen bg-gray-50">

    <div class="max-w-3xl mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-10">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">반려동물 병원 이용 경험 설문</h1>
            <p class="text-gray-500">솔직한 의견을 통해 더 나은 진료 정보 환경을 만들어갑니다.</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button class="tab-btn active px-4 py-2 text-sm font-medium border-b-2 border-primary text-primary transition duration-150" data-target="survey">
                설문 작성하기
            </button>
            <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 transition duration-150" data-target="submissions">
                다른 사람 의견 보기
            </button>
        </div>

        <!-- 1. Survey Panel -->
        <div id="survey" class="tab-panel active">
            <form id="petSurveyForm" class="space-y-6">
                <!-- Message Area -->
                <p id="msg" class="text-center text-sm font-medium min-h-6"></p>

                <!-- Q1. 반려동물 보유 (hasPet) -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">Q1. 반려동물을 현재 키우고 계십니까?</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="hasPet" value="예" class="form-radio h-4 w-4 text-primary transition duration-150 ease-in-out" required>
                            <span class="ml-2 text-gray-700">예</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="hasPet" value="아니오" class="form-radio h-4 w-4 text-primary transition duration-150 ease-in-out">
                            <span class="ml-2 text-gray-700">아니오</span>
                        </label>
                    </div>
                </div>

                <!-- Q2. 거주 지역 (region, regionOther) -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">Q2. 주로 거주하시는 지역을 선택해 주세요.</label>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="region" value="서울" class="form-radio h-4 w-4 text-primary" required>
                            <span class="ml-2 text-sm text-gray-700">서울</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="region" value="경기/인천" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">경기/인천</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="region" value="부산/경남" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">부산/경남</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="region" value="대구/경북" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">대구/경북</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="region" value="광주/전라" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">광주/전라</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="region" value="대전/충청" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">대전/충청</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="region" value="강원/제주" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">강원/제주</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="region" value="기타" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">기타 (직접 입력)</span>
                        </label>
                    </div>
                    <input type="text" name="regionOther" placeholder="직접 입력" style="display:none;" class="mt-3 w-full border-gray-300 rounded-lg shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-sm">
                </div>

                <!-- Q3. 병원 선택 기준 (priorityCriteria) -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">Q3. 동물병원 선택 시 가장 중요하게 고려하는 기준은 무엇입니까? (중복 선택 가능)</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-secondary/10 transition">
                            <input type="checkbox" name="priorityCriteria" value="의료진의 전문성 및 경험" class="form-checkbox h-4 w-4 text-secondary rounded">
                            <span class="ml-2 text-sm text-gray-700">의료진의 전문성 및 경험</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-secondary/10 transition">
                            <input type="checkbox" name="priorityCriteria" value="진료비의 투명성과 합리성" class="form-checkbox h-4 w-4 text-secondary rounded">
                            <span class="ml-2 text-sm text-gray-700">진료비의 투명성과 합리성</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-secondary/10 transition">
                            <input type="checkbox" name="priorityCriteria" value="병원 시설 및 장비의 수준" class="form-checkbox h-4 w-4 text-secondary rounded">
                            <span class="ml-2 text-sm text-gray-700">병원 시설 및 장비의 수준</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-secondary/10 transition">
                            <input type="checkbox" name="priorityCriteria" value="병원 접근성 및 위치" class="form-checkbox h-4 w-4 text-secondary rounded">
                            <span class="ml-2 text-sm text-gray-700">병원 접근성 및 위치</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-secondary/10 transition">
                            <input type="checkbox" name="priorityCriteria" value="친절도 및 서비스" class="form-checkbox h-4 w-4 text-secondary rounded">
                            <span class="ml-2 text-sm text-gray-700">친절도 및 서비스</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-secondary/10 transition">
                            <input type="checkbox" name="priorityCriteria" value="진료 시간/예약 시스템 편리성" class="form-checkbox h-4 w-4 text-secondary rounded">
                            <span class="ml-2 text-sm text-gray-700">진료 시간/예약 시스템 편리성</span>
                        </label>
                    </div>
                </div>

                <!-- Q4. 우려/필요 기능 (concernAndFeature) -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <label for="concernAndFeature" class="block text-lg font-semibold text-gray-700 mb-3">Q4. 현재 동물병원을 이용하면서 느끼는 가장 큰 우려사항 또는 필요하다고 느끼는 기능이 있다면 자유롭게 적어주세요.</label>
                    <textarea id="concernAndFeature" name="concernAndFeature" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-sm p-2" placeholder="자유롭게 의견을 작성해 주세요."></textarea>
                </div>

                <!-- Q5. 중요 정보 1, 2순위 (priority1, priority2) -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm space-y-4">
                    <h2 class="block text-lg font-semibold text-gray-700">Q5. 동물병원이 제공하는 정보 중 가장 중요하게 생각하는 1, 2순위는 무엇입니까?</h2>
                    
                    <div>
                        <label for="priority1" class="block text-base font-medium text-gray-700 mb-1">1순위 정보</label>
                        <select id="priority1" name="priority1" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-sm p-2" required>
                            <option value="" disabled selected>선택</option>
                            <option value="후기/평점">후기/평점</option>
                            <option value="상세 진료 내용">상세 진료 내용</option>
                            <option value="의료진 경력">의료진 경력</option>
                            <option value="장비/시설 정보">장비/시설 정보</option>
                            <option value="진료비 정보">진료비 정보</option>
                            <option value="진료 가능 시간">진료 가능 시간</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>

                    <div>
                        <label for="priority2" class="block text-base font-medium text-gray-700 mb-1">2순위 정보</label>
                        <select id="priority2" name="priority2" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 text-sm p-2" required>
                            <option value="" disabled selected>선택</option>
                            <option value="후기/평점">후기/평점</option>
                            <option value="상세 진료 내용">상세 진료 내용</option>
                            <option value="의료진 경력">의료진 경력</option>
                            <option value="장비/시설 정보">장비/시설 정보</option>
                            <option value="진료비 정보">진료비 정보</option>
                            <option value="진료 가능 시간">진료 가능 시간</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                </div>

                <!-- Q6. 지불 의향 금액 (priceRange) -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">Q6. 중대 진료 시, 진료 정보 플랫폼에 어느 정도의 금액을 지불할 의향이 있습니까?</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="priceRange" value="~1만원" class="form-radio h-4 w-4 text-primary" required>
                            <span class="ml-2 text-sm text-gray-700">~1만원</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="priceRange" value="1만원~3만원" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">1만원~3만원</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="priceRange" value="3만원~5만원" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">3만원~5만원</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="priceRange" value="5만원 이상" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">5만원 이상</span>
                        </label>
                        <label class="inline-flex items-center bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-primary/10 transition">
                            <input type="radio" name="priceRange" value="지불 의향 없음" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">지불 의향 없음</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 bg-primary text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 ease-in-out">
                    제출하기
                </button>
            </form>
        </div>

        <!-- 2. Submissions Panel -->
        <div id="submissions" class="tab-panel">
            <h2 class="text-xl font-bold text-gray-700 mb-4">다른 사람들의 의견 (최신 10개)</h2>
            <div id="submissionsList" class="space-y-4">
                <div class="placeholder text-center text-gray-500 p-4 border rounded-lg">탭을 클릭하면 최신 기록을 불러옵니다.</div>
            </div>
        </div>
    </div>

    <!-- The original JavaScript code is embedded here -->
    <script>
// === 수정된 JavaScript 코드 (중복 제출 방지 및 URL 업데이트 버전) ===
document.addEventListener("DOMContentLoaded", () => {
  // Google Apps Script URL (고객님께서 요청하신 링크로 최종 업데이트)
  const API_URL = 'https://script.google.com/macros/s/AKfycbwfqm6JLNMXqL1MTumvEMuCp_IeBnddDMmIKocbQaMqOzXXayFz9DzdUWHnyt4LZEZ6AA/exec';
  
  const form = document.getElementById("petSurveyForm");
  const msg = document.getElementById("msg");
  const submissionsList = document.getElementById("submissionsList");
  const regionOtherInput = document.querySelector('input[name="regionOther"]');
  const tabBtns = document.querySelectorAll(".tab-btn");

  let localSubmissions = []; // 서버에서 불러온 전체 데이터
  let isSubmitting = false; // 💡 제출 잠금 플래그 추가

  // ⭐️ 1. 시트 컬럼 이름과 출력 라벨 정의 ⭐️
  const keyMap = {
    hasPet: "반려동물 보유",
    region: "지역",
    regionOther: "직접 입력 지역",
    priorityCriteria: "병원 선택 기준 (Q3)",
    concernAndFeature: "우려/필요 기능 (Q4)",
    priceRange: "지불 의향 금액 (Q6)",
    priority1: "1순위 정보",
    priority2: "2순위 정보",
  };

  // ⭐️ 2. 표시할 핵심 항목을 올바른 키로 정의 ⭐️
  const displayKeys = ["priorityCriteria", "priceRange", "concernAndFeature"];

  /**
   * 서버에서 최신 데이터를 가져와 localSubmissions를 갱신하고, 화면을 다시 그리는 함수
   */
  const fetchSubmissions = async () => {
    try {
      const uniqueApiUrl = `${API_URL}?t=${new Date().getTime()}`;
      submissionsList.innerHTML = '<div class="placeholder">제출된 기록을 불러오는 중입니다...</div>';

      const res = await fetch(uniqueApiUrl);
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

      const data = await res.json();

      if (Array.isArray(data)) {
        localSubmissions = data;
        renderSubmissions(); // 목록 갱신
      } else {
        submissionsList.innerHTML = '<div class="placeholder">데이터 로딩 실패: 서버 응답 형식이 올바르지 않습니다.</div>';
      }
    } catch (error) {
      console.error("서버 데이터 로딩 오류:", error);
      submissionsList.innerHTML = '<div class="placeholder">네트워크 오류 또는 서버 오류로 데이터를 불러올 수 없습니다.</div>';
    }
  };

  // 2. 폼 제출 (POST 후, 전체 데이터 재요청 로직 포함) - 중복 제출 방지 수정
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector('button[type="submit"]'); // 버튼 찾기

    if (isSubmitting) { // 💡 중복 제출 방지 체크
      msg.textContent = "⚠️ 이미 제출 중입니다. 잠시만 기다려 주세요.";
      return;
    }

    // 💡 제출 시작 시 잠금 및 버튼 비활성화
    isSubmitting = true;
    submitBtn.disabled = true;
    submitBtn.textContent = "제출 중...";
    msg.textContent = "✅ 제출 중...";

    const data = new FormData(form);
    const payload = {};
    
    // FormData를 JSON payload로 변환 (체크박스 값 처리 포함)
    const formKeys = ['hasPet', 'region', 'regionOther', 'concernAndFeature', 'priority1', 'priority2', 'priceRange'];
    
    // 일반 키 처리
    for (const k of formKeys) {
        if (data.has(k)) {
            payload[k] = data.get(k);
        }
    }

    // 체크박스 (priorityCriteria) 처리: 여러 값을 쉼표로 연결
    const criteriaValues = data.getAll('priorityCriteria');
    if (criteriaValues.length > 0) {
        payload['priorityCriteria'] = criteriaValues.join(', ');
    } else {
        // GAS에 보낼 때 필드가 누락되지 않도록 빈 문자열로 보냄 (체크된 항목이 없는 경우)
        payload['priorityCriteria'] = ''; 
    }

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        const result = await response.json();
        if (result.status === 'success') {
          msg.textContent = "💌 제출이 완료되었습니다! 의견 목록을 갱신합니다.";
          
          await fetchSubmissions();
          form.reset();
          regionOtherInput.style.display = "none";
          
          // '다른 사람 의견 보기' 탭으로 자동 전환 및 활성화
          document.querySelector('.tab-btn[data-target="submissions"]').click();
        } else {
          throw new Error(result.message || '서버에서 오류가 발생했습니다.');
        }
      } else {
        throw new Error(`HTTP 오류: ${response.status}`);
      }

    } catch (error) {
      console.error('제출 오류:', error);
      msg.textContent = `⚠️ 제출 실패: ${error.message}`;
      
    } finally {
      // 💡 성공/실패와 관계없이 잠금 해제 및 버튼 활성화
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.textContent = "제출하기";
    }
  });

  // 3. submissions 렌더링 (displayKeys 적용)
  const renderSubmissions = () => {
    submissionsList.innerHTML = "";

    if (localSubmissions.length === 0) {
      submissionsList.innerHTML = '<div class="placeholder">아직 제출된 기록이 없습니다.</div>';
      return;
    }

    // 최신 10개만 표시
    localSubmissions.slice().reverse().slice(0, 10).forEach((sub, index) => {
      const card = document.createElement("div");
      card.className = "record fade-in";
      card.style.setProperty('--delay', `${index * 0.05}s`);

      let html = displayKeys
        .map(k => {
          const label = keyMap[k];
          let value = sub[k];
          const displayValue = (value && value !== "" && value !== " ") ? value : "응답 없음";
          return `<div class="record-item p-2">
            <strong>${label}:</strong>
            <span class="${displayValue === '응답 없음' ? 'text-muted' : 'text-accent'}">${displayValue}</span>
          </div>`;
        })
        .join("");

      if (!html) html = "<div>제출된 정보 없음</div>";
      card.innerHTML = html;
      submissionsList.appendChild(card);
    });
  };

  // 4. 탭 클릭 이벤트
  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      tabBtns.forEach(b => b.classList.remove("active", "border-primary", "text-primary"));
      tabBtns.forEach(b => b.classList.add("border-transparent", "text-gray-500"));
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));

      btn.classList.add("active", "border-primary", "text-primary");
      btn.classList.remove("border-transparent", "text-gray-500");
      document.getElementById(btn.dataset.target).classList.add("active");

      if (btn.dataset.target === "submissions") {
        fetchSubmissions();
      }
    });
  });

  // 5. "기타" 입력 토글
  document.querySelectorAll('input[name="region"]').forEach(radio => {
    radio.addEventListener('change', () => {
      if (radio.value === "기타") {
        regionOtherInput.style.display = "block";
        regionOtherInput.required = true;
      } else {
        regionOtherInput.style.display = "none";
        regionOtherInput.required = false;
      }
    });
  });
});
    </script>
</body>
</html>
